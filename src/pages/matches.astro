---
import Layout from "../layouts/Layout.astro";

import { getSession } from "auth-astro/server";
const session = await getSession(Astro.request);
if (!session) {
  return Astro.redirect("/login");
}
const { user } = session;

import { actions } from "astro:actions";
const { data: matchesData, error: matchesError } = await Astro.callAction(
  actions.getMatchesUser,
  {
    userId: user?.id,
  }
);
---

<Layout>
  <h1 class="text-2xl">Matches</h1>

  <div class="flex justify-end">
    <a href="/new-match">
      <button type="button" class="bg-black text-white rounded-lg px-5 py-2.5">
        Create new match
      </button>
    </a>
  </div>

  <table>
    <thead>
      <tr>
        <th> Id </th>
        <th> Players </th>
        <th> Winner </th>
        <th> Date created </th>
      </tr>
    </thead>
    <tbody>
      {
        matchesData?.matches?.map((match) => (
          <tr>
            <th>
              <a href={`/matches/${match.matchId}`}>{match.matchId}</a>
            </th>
            <td>
              {match.participants.map((player, index) => (
                <span>
                  {player.name}
                  {index < match.participants.length - 1 ? " - " : ""}
                </span>
              ))}
            </td>
            <td>
              {match.winner ? match.winner.winnerName : "No winner"}
            </td>
            <td> {match.createdAt.toLocaleDateString("en-GB")} </td>
          </tr>
        ))
      }
    </tbody>
  </table>
</Layout>
